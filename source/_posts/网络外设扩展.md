---
title: 网络外设扩展
date: 2026-02-12 15:23:18
tags:
	- Ethernet
categories:
	- 科研实践
---



本项目旨在基于开源高性能处理器香山“昆明湖”的FPGA原型验证环境实现网络外设扩展。在保持系统原有功能的前提下，增加Ethernet模块及相应软件驱动/协议栈支持，使系统能够通过网络收发数据，与外部设备（如PC、交换机）交互，从而满足复杂系统级测试、远程控制及网络终端应用需求。

{% asset_img ETH_shell.png 网络外设扩展 %}

如图所示，Shell基本功能及PHY已具备，本项目的核心工作即为在Shell中添加Ethernet功能模块实现Role和外部网络设备的数据传输。

项目进程可以大致分为以下阶段：

---

## 基础知识学习

### vivado使用

- IP intergrator 

- RTL Analysis

- Systhesis

- Generate Bitstream

### 网络

#### PHY

PHY（Physical Layer，物理层）是OSI模型中的第一层，负责在物理介质（如电缆、光纤）上传输和接收原始比特流。

#### MAC

MAC（Media Access Control，媒体访问控制）位于OSI模型的数据链路层（第二层），负责管理数据帧的传输和接收，确保数据在局域网内的有序、无冲突传输。


#### GMII

（Gigabit MII）： GMII 接口向下兼容 MII 接口， 支持 10Mbps、 100Mbps 和 1000Mbps 的操作，数据位宽为 8 位 在 1000Mbps 传输速率下，时钟频率为 125Mhz 在 100Mbps 传输速率下，时钟频率为 25Mhz 在 10Mbps 传输速率下，时钟频率为 2.5Mhz


#### SGMII

SGMII（Serial Gigabit Media Independent Interface）是一种用于千兆以太网的串行接口标准，用于连接MAC层和PHY层，减少引脚数量，提高通信效率。

#### RGMII

（Reduced GMII）： RGMII 是 GMII 的简化版，数据位宽为 4 位 在 1000Mbps 传输速率下，时钟频率为 125Mhz，在时钟的上下沿同时采样数据 在 100Mbps传输速率下，时钟频率为25MHz，为单个时钟沿采样 在 10Mbps传输速率下，时钟频率为2.5MHz，为单个时钟沿采样 在千兆以太网中，常用的接口为 RGMII 和 GMII 接口。


#### RMII

是 Reduced Media Independent Interface 的缩写，中文通常翻译为 简化介质无关接口。

它是一种用于连接以太网媒体访问控制器（MAC）和物理层（PHY）芯片的接口标准，是IEEE 802.3标准的一部分。

#### MDI

是 Medium Dependent Interface 的缩写，中文通常翻译为 介质相关接口。

它是 OSI 模型物理层（Layer 1）的一部分，定义了网络设备（如网卡、交换机、集线器）的物理端口如何与特定类型的传输介质（如双绞线、光纤、同轴电缆等）进行连接。
#### AXI 

（Advanced eXtensible Interface，高级可扩展接口）是ARM公司提出的AMBA（Advanced Microcontroller Bus Architecture）协议的一部分，是一种面向高性能、高带宽、低延迟的片上总线协议。它被广泛应用于现代SoC（System-on-Chip，片上系统）设计中，以满足复杂多核系统的数据通信需求。以下从定义、特点、核心机制、应用场景和优势等方面为您详细解析AXI协议。

#### 以太网

是由Xerox公司于20世纪70年代在帕洛阿尔托研究中心（PARC）开发的一种基带**局域网**技术。

#### MDIO和MDC

MDIO全称为"Management Data Input/Output"，即管理数据输入输出；而MDC全称为"Management Data Clock"，即管理数据时钟。

是现代以太网通信中两个重要的信号线，它们共同构成了MDIO（Management Data Input/Output）接口，用于MAC（介质访问控制）层与PHY（物理层）之间的管理通信。

#### DHCP
（Dynamic Host Configuration Protocol，动态主机配置协议）

通常被应用在大型的局域网络环境中，主要作用是集中的管理、分配IP地址，使网络环境中的主机动态的获得IP地址、Gateway地址、DNS服务器地址等信息，并能够提升地址的使用率。

### xdma（Xilinx DMA）的使用

是 Xilinx提供的一种 基于 PCIe 的高速 DMA 解决方案，常用于 FPGA 与主机之间进行大规模高速数据传输。
即 让 FPGA 和 PC 内存之间高速搬运数据的“通道”。

IP核中部分设置如下：

{% asset_img xdma.png IP核介绍 %}

### ILA 工具的使用

- 在BD设计中添加ILA 对应IP，抓取相应的数据
- 在后续过程中会生成对应的.ltx文件
- 生成bitstream后进入Open Hardware Manager 进行烧录后重启
- 再一次进入Open Hardware Manager

{% asset_img open_hw_manager.png open_hw_manager %}

- 点击specify the probes file and refresh the device添加.ltx文件

- 点击 + 添加trigger并设置触发条件

{% asset_img ila_trigger.png ila_trigger %}

### Xilinx收费IP核hardware_evaluation license申请

参看博客[apply](https://blog.csdn.net/zd1314798/article/details/149838003?sharetype=blogdetail&sharerId=149838003&sharerefer=PC&sharesource=zd1314798&spm=1011.2480.3001.8118)


补充 IP license的类型说明：

design_linking：允许客户进行包括时许仿真的各种仿真，但是不能生成bit文件

hardware_evaluation license：这就是申请的license，允许生成bit文件，但有时间限制，一定时间后不能使用。

key for product use：购买生成的license，全部功能都可以使用。

### 设备树（Device Tree）
一种描述硬件资源的数据结构，可以通过 bootloader 将它传给内核，内核（Kernal）使用它对硬件进行初始化，好处是使得内核和硬件资源描述相对独立，不需要太多的硬编码。

---

## 通过XDMA控制多时钟下LED

在xczu19eg-ffvc1760-2-e芯片上实现xdma_ep模块功能，完成PCIe总线信号与AXI协议的转换，并实现100 MHz与250 MHz时钟域下不同LED灯的控制。此过程帮助熟悉XDMA的使用、ILA调试及多时钟域概念，为后续Ethernet模块调试奠定基础。


---

### 单一时钟实现

在xczu19eg-ffvc1760-2-e芯片上实现图示模块功能，利用xdma_ep模块实现pcie标准总线信号到axi总线协议信号转变，通过axi_gpio_0 IP核 控制4个LED灯。

#### BD设计

{% asset_img single_freq_xdma.png 单频率控制 %}

#### 运行

在服务器上运行设计好的模块，正确控制LED灯。

**流程**：

```bash
# 连接内网

#检测目标设备是否开机并联网
ping 10.128.157.241

# 连接服务器

# 打开vivado
 /opt/Xilinx_2020.2/Vivado/2020.2/bin/vivado -nolog -nojour

# 烧录
 open hard ware manager -> open target -> program device -> add bit stream 

# 终端运行
sudo reboot #重启
sudo insmod xdma.ko # 加载驱动

# 读操作
sudo ~/proto/pcie-util /dev/xdma0_user read 0x00000000
```

#### 添加 ILA 调试

实现图示block design的模块，利用ILA抓取M_AXI_LITE以及GPIO数据，进行调试。

{% asset_img ila_1freq.png ila_single_freq %}

### 分频率GPIO设计

扩展GPIO，实现不同频率的GPIO控制（100MHz，250MHz）；进行引脚约束。

{% asset_img div_freq.png 分频GPIO BD %}


板卡号:xczu19eg-ffvc1760-2-e (active)

---

基本思路

- 添加clock wizard IP核，得到100MHz和250MHz的时钟信号；

---

- 添加axi interconnect IP核，将xdma的M_AXI_LITE信号分为两个不同频率的信号。
[axi interconnect](https://gitcode.com/Open-source-documentation-tutorial/eddcb/blob/main/pg059-axi-interconnect.pdf)

- 添加Processor System Reset保证时序一致

---


引脚约束

```bash
set_property PACKAGE_PIN E16 [get_ports {GPIO_0_tri_io[3]}]
set_property PACKAGE_PIN D16 [get_ports {GPIO_0_tri_io[2]}]
set_property PACKAGE_PIN C16 [get_ports {GPIO_0_tri_io[1]}]
set_property PACKAGE_PIN B16 [get_ports {GPIO_0_tri_io[0]}]
set_property PACKAGE_PIN N10 [get_ports pcie_ep_perstn]
 
set_property PACKAGE_PIN AF11 [get_ports {pcie_ep_gt_ref_clk_clk_n[0]}]
set_property PACKAGE_PIN AF12 [get_ports {pcie_ep_gt_ref_clk_clk_p[0]}]
 
set_property IOSTANDARD LVCMOS33 [get_ports pcie_ep_perstn]
set_property IOSTANDARD LVCMOS18 [get_ports {GPIO_0_tri_io[3]}]
set_property IOSTANDARD LVCMOS18 [get_ports {GPIO_0_tri_io[2]}]
set_pjroperty IOSTANDARD LVCMOS18 [get_ports {GPIO_0_tri_io[1]}]
set_property IOSTANDARD LVCMOS18 [get_ports {GPIO_0_tri_io[0]}]
```

#### debug

- **在服务器上运行过程中发现read全为ffffffff，且不能读。**

通过阅读手册得知：在读写之前，需要将基地址偏移量为0x0004的寄存器设置为0。

[三态GPIO](https://hthreads.github.io/classes/embedded-systems/labs/lab2/assets/datasheets/axi-gpio.pdf)

{% asset_img tri_axi.png tri_axi %}

---

- **通过ILA IP核抓取M_AXI_LITE信号对比发现，低地址读取触发正常，高地址读取时虽然服务器读取值任为全f，但不能正常触发。**

在分频gpio基础上添加ILA IP核抓取S_AXI信号进行调试。

xdma IP核中PCIe to AXI Translation为0x1000_0000。

推断是基地址设定的问题，修改完善Address Map，烧录bit运行。

{% asset_img axi_addr.png axi_addr %}

最终成功读写。

## Ethernet 模块设计

参考VCU128平台，完成Ethernet模块设计。通过XDMA控制Ethernet模块寄存器读写，实现MAC与PHY的互联。

---

### 基于Xilinx VCU128板卡的SERVE.h平台设计

{% asset_img vcu128_design.png vcu128_design %}

- GEM(Gigabit Ethernet MAC)


Ethernet 部分为
```scss
axi_mmio_ic (AXI4-Lite)
        ↓
        GEM
        ↓
        DMA
        ↓
axi_dma_ic (AXI4)
        ↓
		DDR4
```

### 基于 vu19p 的设计

了解 基于Xilinx VCU128板卡的SERVE.h平台设计，明确大致任务方向；

通过vcu128的设计，掌握Ethernet System IP、DMA IP的原理及使用方法。

基于vu19p着手设计:

{% asset_img vu19p_bd.png vu19p_bd %}

#### debug

- **license**

{% asset_img license_error.png license_error %}

报错说明存在IP核不允许生成bitstream

进入AXI 1G/2.5G Ethernet Subsystem IP核re-customize界面，确实发现最下角为design linking license字样。

- **rx/tx lane**

在Xilinx VU19P FPGA中，I/O bank通常被划分为多个Tri-state（T）组，例如 T0、T1、T2 和 T3，这一分区主要与I/O引脚的分配、数据流控制和接口标准有关。为了更详细地解释这一结构，我们需要深入了解几个关键概念：I/O Bank、Tri-state（T）、以及如何将这些划分映射到FPGA的实际硬件架构上。

 - 每组T控制多个Lane：一个T组控制多个lane，而每个lane又可以携带多个nibble。例如，PCIe协议中的数据传输通常是通过多个lane并行传输的。在一个Bank中，T组（如T0、T1、T2、T3）管理每个lane的数据传输，确保数据可以同时从多个通道传输，从而增加带宽。

 - 多个nibble组成一个lane：每个lane可以划分为两个nibble，每个nibble包含4位数据。这样，数据传输过程就被拆分成更小的部分，通过不同的lane并行工作来提高传输速率。例如，一个lane如果包含两个nibble（即8位），通过并行的lane，可以组成16位、32位等宽的数据通道。

在将vcu128移植到vu19p上时，需要考虑到这一点，阅读电路原理图，决定lane的选择。

[vcu128 与 vu19p lane 的处理 差异](https://blog.csdn.net/zd1314798/article/details/150386233?spm=1001.2014.3001.5501)

在IP核设置差分线：

{% asset_img lane.png lane %}

此处需要依据电路原理图进行选择。
如图，TX信号位于T1L分区的第二对，RX位于T0L分区的第三对，故此处需要选pair 1,和pair 2 。
{% asset_img vu19p_lane.png vu19p %}

#### 上板读写

通过管理接口访问 MDIO 接口完全是基于寄存器映射的。

具体操作流程如下参见：

[MDIO读写](https://blog.csdn.net/zd1314798/article/details/150394076?spm=1001.2014.3001.5501)

## Shell模块集成

在vu19p上搭建ethernet工程

### Block Design

{% asset_img shell.png shell %}

### 上板
{% asset_img vu19p_fpga.png vu19p_fpga %}

### 定位PHY，完善片选，加入ILA调试

- 通过读取REGAD=2/3寻找PHY的地址为3。

- 根据原理图及相应器件手册，加入相应IP实现片选始终为19p；
给MDIO加上ILA进行调试；

### debug

Ethernet内部寄存器可以读写，故Ethernet及前序模块没问题，而Ethernet及PHY之间通信的mdio、sgmii也正常工作，还可能存在问题的输出引脚为RJ45_sgmii_select，检查后发现将其约束到了ETH_select，改之则成功。

## 软件与连接

在硬件基础上，配置操作系统驱动以支持硬件IP（比如 Xilinx AXI Ethernet MAC + AXI DMA），让 Linux 内核知道如何访问这些硬件寄存器、如何收发数据。

同时编写设备树，描述Ethernet MAC和DMA在SoC总线的地址范围中断号；PHY芯片配置等，使得Linux 启动读取Device Tree Blob (DTB)时得到板卡硬件结构，完成驱动和硬件的绑定。

### 驱动部分要点

#### 修改chosen解决error-22。

```bash
 
        chosen {
                bootargs = "root=/dev/nvme0n1p2 earlycon=sbi console=ttyUL0";
        };
```

- 将Ethernet 和dma对应设备树中的配置信息进行修改，对设备时钟做出相应约束，能够成功查找到Ethernet设备。

```bash
            compatible = "xlnx,axi-dma-1.00.a";
          
            compatible = "xlnx,axi-ethernet-1.00.a";
                            
            max-speed=<100000>;
```

发现能够查找到设备，但是进一步 ip link set eht0 up没能成功启动eth设备。

{% asset_img eth0.png eth0 %}

后续问题：接口已经启动，但物理链路未连接。

#### ILA及示波器对数据进行探测 

在shell中添加ILA抓取一些总线的数据，同时直接利用示波器对一些开发板上的针脚进行探测，查看数据有无、频率等信息。发现PHY没有正确给MAC时钟，初始时有一个125Mhz的时钟，后续link up之后就没了。判断是PHY内部的问题。

{% asset_img wave.png wave %}

> 示波器

- 添加xdma读写Ethernet模块，对PHY进行配置

{% asset_img phy_ctr_reg.png phy_ctr_reg %}

- 利用示波器探测时钟针脚（33），看看是否有625MHZ时钟。

{% asset_img pin.png pin %}

**发现问题**:没有625MHZ时钟

dp83867is手册 + ILA

#### 修改开发板

主要内容：利用软件层面的驱动将sgmii_enable置1，同时也对开发板做出修改。

{% asset_img mode.png mode %}

{% asset_img clk_mode.png clk_mode %}

阅读电路原理图发现目前是mode 1

{% asset_img led_mode.png led_mode %}

因此Sgmii Enable没有置1

而后通过硬件上电路的修改以及上层软件的直接写入，实现设置

后续可以探测到625MHZ的时钟。







